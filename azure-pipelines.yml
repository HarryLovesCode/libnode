trigger:
- master


variables:
  LIBNODE_NODE_VERSION: 'v12.13.0'

jobs:
  - job: build
    strategy:
      matrix:
        linux:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl'
          LIBNODE_ZIP_SUFFIX: '-nointl'
          LIBNODE_X86: '0'
          imageName: 'ubuntu-18.04'
        mac:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl'
          LIBNODE_ZIP_SUFFIX: '-nointl'
          LIBNODE_X86: '0'
          imageName: 'macos-10.13'
        win_x64:
          LIBNODE_X86: '0'
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl'
          LIBNODE_ZIP_SUFFIX: '-nointl'
          imageName: 'vs2017-win2016'
        win_x86:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl'
          LIBNODE_ZIP_SUFFIX: '-nointl'
          LIBNODE_X86: '1'
          imageName: 'vs2017-win2016'
        linux_nossl:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl --without-ssl'
          LIBNODE_ZIP_SUFFIX: '-nointl-nossl'
          LIBNODE_X86: '0'
          imageName: 'ubuntu-18.04'
        mac_nossl:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl --without-ssl'
          LIBNODE_ZIP_SUFFIX: '-nointl-nossl'
          LIBNODE_X86: '0'
          imageName: 'macos-10.13'
        win_x64_nossl:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl --without-ssl'
          LIBNODE_ZIP_SUFFIX: '-nointl-nossl'
          LIBNODE_X86: '0'
          imageName: 'vs2017-win2016'
        win_x86_nossl:
          LIBNODE_CONFIG_FLAGS: '--without-node-options --without-intl --without-ssl'
          LIBNODE_ZIP_SUFFIX: '-nointl-nossl'
          LIBNODE_X86: '1'
          imageName: 'vs2017-win2016'
    pool:
      vmImage: $(imageName)


    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '2.7'
        addToPath: true
        architecture: 'x64'

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.5'
        addToPath: false
        architecture: 'x64'

    - script: |
        pip3 install cmake
      condition: eq( variables['Agent.OS'], 'Linux' )
      displayName: 'Install newer(3.13+) CMake on Linux'

    - script: |
        choco install nasm -y
      condition: eq( variables['Agent.OS'], 'Windows_NT' )
      displayName: 'Install nasm on Windows'

    - bash: |
        $USEPYTHONVERSION2_PYTHONLOCATION/python -m scripts.download
      displayName: 'Download source code of Node.js'

    - bash: |
        $USEPYTHONVERSION2_PYTHONLOCATION/python -m scripts.build
      displayName: 'Build'

    - bash: |
        $USEPYTHONVERSION2_PYTHONLOCATION/python -m scripts.postproc
      displayName: 'Postprocess'

    - bash: |
        $USEPYTHONVERSION2_PYTHONLOCATION/python -m scripts.test
      displayName: 'Test'

    - bash: |
        output=$($USEPYTHONVERSION2_PYTHONLOCATION/python -m scripts.archive)
        echo "##vso[task.setvariable variable=zip_file;]$output"
      displayName: 'Archive'
    
    - task: PublishBuildArtifacts@1
      inputs:
        artifactName: $(zip_file)
        pathtoPublish: $(zip_file)
        
  - job: gh_release
    dependsOn: build
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        downloadType: 'specific'
        downloadPath: $(Build.ArtifactStagingDirectory)
    - task: GitHubRelease@0
      inputs:
        gitHubConnection: 'GitHub connection 1'
        repositoryName: patr0nus/libnode
        action: 'create'
        target: '$(Build.SourceVersion)'
        tagSource: 'manual'
        tag: 'libnode-$(LIBNODE_NODE_VERSION)'
        assets: '$(Build.ArtifactStagingDirectory)/*/*'
        isDraft: false
        addChangeLog: false
